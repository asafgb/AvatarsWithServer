'use strict';

Object.defineProperty(exports, "__esModule", {
  value: true
});

var _pify = require('pify');

var _pify2 = _interopRequireDefault(_pify);

var _simpleKerberosError = require('./simple-kerberos-error');

var _simpleKerberosError2 = _interopRequireDefault(_simpleKerberosError);

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

var kerberos = void 0;

try {
  var kerberosModule = require('kerberos');

  kerberos = new kerberosModule.Kerberos();
} catch (err) {
  throw new _simpleKerberosError2.default('Simple Kerberos failed to load the "kerberos" module', err);
}

exports.default = (0, _pify2.default)(function (token, cb) {
  kerberos.authGSSServerInit('HTTP', function (err, context) {
    if (err) {
      return cb(new _simpleKerberosError2.default('Simple Kerberos failed at "init" stage', err));
    }

    kerberos.authGSSServerStep(context, token, function (err) {
      if (err) {
        return cb(new _simpleKerberosError2.default('Simple Kerberos failed at "step" stage', err));
      }

      var username = context.username;


      kerberos.authGSSServerClean(context, function (err) {
        if (err) {
          return cb(new _simpleKerberosError2.default('Simple Kerberos failed at "clean" stage', err));
        }

        cb(null, username);
      });
    });
  });
});
//# sourceMappingURL=index.js.map